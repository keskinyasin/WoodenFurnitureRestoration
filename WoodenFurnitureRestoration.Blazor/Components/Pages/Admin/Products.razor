@page "/admin/products"
@rendermode InteractiveServer
@attribute [StreamRendering(false)]
@attribute [AuthorizeAdmin]
@layout AdminLayout
@using WoodenFurnitureRestoration.Blazor.Services
@using WoodenFurnitureRestoration.Blazor.Components.Shared
@using WoodenFurnitureRestoration.Shared.DTOs.Product
@using WoodenFurnitureRestoration.Shared.DTOs.Category
@using WoodenFurnitureRestoration.Shared.DTOs.Supplier
@using WoodenFurnitureRestoration.Shared.DTOs.SupplierMaterial
@inject AuthService AuthService
@inject ProductService ProductService
@inject CategoryService CategoryService
@inject SupplierService SupplierService
@inject SupplierMaterialService SupplierMaterialService
@inject NavigationManager Navigation
@inject ILogger<Products> Logger

@if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;"><div class="spinner-border text-primary" role="status"></div></div>
}
else
{
    <ToastNotification IsVisible="@showToast" Title="@toastTitle" Message="@toastMessage" Type="@toastType" OnClose="() => showToast = false" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">🛋️ Ürünler Yönetimi</h2>
            <p class="text-muted mb-0">Toplam @products.Count ürün | <strong class="text-success">₺@products.Sum(p => p.Price).ToString("N2")</strong></p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="OpenAddModal"><i class="bi bi-plus-circle me-2"></i> Yeni Ürün</button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="🔍 Ürün ara..." @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="filterCategoryId" @bind:after="ApplyFilters">
                        <option value="0">Tüm Kategoriler</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="filterSupplierId" @bind:after="ApplyFilters">
                        <option value="0">Tüm Tedarikçiler</option>
                        @foreach (var s in suppliers)
                        {
                            <option value="@s.Id">@s.SupplierName</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else if (filteredProducts?.Count == 0)
            {
                <div class="text-center py-5"><i class="bi bi-box text-muted" style="font-size: 4rem;"></i><p class="mt-3 text-muted fs-5">Ürün bulunamadı</p></div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ürün</th>
                                <th>Kategori</th>
                                <th>Tedarikçi</th>
                                <th>Fiyat</th>
                                <th class="text-center">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in filteredProducts)
                            {
                                <tr>
                                    <td><span class="badge bg-secondary">@product.Id</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary text-white rounded d-flex align-items-center justify-content-center me-2" style="width: 45px; height: 45px;"><i class="bi bi-box"></i></div>
                                            <div>
                                                <strong>@product.Name</strong>
                                                <br /><small class="text-muted">@(product.Description?.Length > 30 ? product.Description.Substring(0, 30) + "..." : product.Description)</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-info"><i class="bi bi-folder me-1"></i>@product.CategoryName</span></td>
                                    <td><span class="badge bg-success"><i class="bi bi-building me-1"></i>@GetSupplierName(product.SupplierId)</span></td>
                                    <td><strong class="text-success fs-5">₺@product.Price.ToString("N2")</strong></td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-info" @onclick="@(() => ViewProduct(product))"><i class="bi bi-eye"></i></button>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenEditModal(product))"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => OpenDeleteDialog(product))"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <AdminModal IsVisible="@showViewModal" Title="🛋️ Ürün Detayı" OnClose="@(() => showViewModal = false)" ShowFooter="false" ModalSize="modal-lg">
        @if (selectedProduct != null)
        {
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;"><i class="bi bi-box text-muted" style="font-size: 4rem;"></i></div>
                </div>
                <div class="col-md-8">
                    <h3>@selectedProduct.Name</h3>
                    <p class="text-muted">@selectedProduct.Description</p>
                    <div class="row mt-4">
                        <div class="col-md-6"><p><strong>Kategori:</strong> <span class="badge bg-info">@selectedProduct.CategoryName</span></p></div>
                        <div class="col-md-6"><p><strong>Tedarikçi:</strong> <span class="badge bg-success">@GetSupplierName(selectedProduct.SupplierId)</span></p></div>
                        <div class="col-md-6"><p><strong>Fiyat:</strong> <span class="text-success fw-bold fs-4">₺@selectedProduct.Price.ToString("N2")</span></p></div>
                    </div>
                </div>
            </div>
        }
    </AdminModal>

    <AdminModal IsVisible="@showModal" Title="@(isEditMode ? "✏️ Ürün Düzenle" : "➕ Yeni Ürün")" OnClose="CloseModal" OnSave="SaveProduct" IsSaving="@isSaving" ModalSize="modal-lg">
        <div class="row">
            <div class="col-md-8 mb-3">
                <label class="form-label fw-bold">Ürün Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @bind="editName" />
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Fiyat <span class="text-danger">*</span></label>
                <div class="input-group"><span class="input-group-text">₺</span><input type="number" step="0.01" class="form-control" @bind="editPrice" /></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold"><i class="bi bi-folder me-1"></i> Kategori <span class="text-danger">*</span></label>
                <select class="form-select" @bind="editCategoryId">
                    <option value="0">-- Kategori Seçin --</option>
                    @foreach (var c in categories)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold"><i class="bi bi-building me-1"></i> Tedarikçi <span class="text-danger">*</span></label>
                <select class="form-select" @bind="editSupplierId" @bind:after="OnSupplierChanged">
                    <option value="0">-- Tedarikçi Seçin --</option>
                    @foreach (var s in suppliers)
                    {
                        <option value="@s.Id">@s.SupplierName</option>
                    }
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold"><i class="bi bi-layers me-1"></i> Malzeme <span class="text-danger">*</span></label>
                <select class="form-select" @bind="editMaterialId">
                    <option value="0">-- Malzeme Seçin --</option>
                    @foreach (var m in filteredMaterials)
                    {
                        <option value="@m.Id">@m.MaterialName</option>
                    }
                </select>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Açıklama <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" @bind="editDescription"></textarea>
        </div>
    </AdminModal>

    <ConfirmDialog IsVisible="@showDeleteDialog" Title="Ürün Sil" Message="Bu ürünü silmek istediğinizden emin misiniz?" ItemName="@deleteItemName" IsProcessing="@isDeleting" OnConfirm="ConfirmDelete" OnCancel="@(() => showDeleteDialog = false)" />
}

@code {
    private bool isAuthenticated, isLoading, isChecked, showViewModal, showModal, isEditMode, isSaving, showDeleteDialog, isDeleting, showToast;
    private List<ProductDto> products = new();
    private List<ProductDto> filteredProducts = new();
    private List<CategoryDto> categories = new();
    private List<SupplierDto> suppliers = new();
    private List<SupplierMaterialDto> materials = new();
    private List<SupplierMaterialDto> filteredMaterials = new();
    private ProductDto? selectedProduct;
    private int editingId, deleteItemId;
    private string deleteItemName = "", toastTitle = "", toastMessage = "";
    private ToastNotification.ToastType toastType;

    private string searchTerm = "";
    private int filterCategoryId, filterSupplierId;
    private string editName = "", editDescription = "";
    private decimal editPrice;
    private int editCategoryId, editSupplierId, editMaterialId;

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender && !isChecked) { isChecked = true; isAuthenticated = await AuthService.IsAdminLoggedInAsync(); if (!isAuthenticated) { Navigation.NavigateTo("/admin", replace: true); return; } await LoadData(); StateHasChanged(); } }

    private async Task LoadData() { isLoading = true; StateHasChanged(); products = await ProductService.GetAllAsync() ?? new(); categories = await CategoryService.GetAllAsync() ?? new(); suppliers = await SupplierService.GetAllAsync() ?? new(); materials = await SupplierMaterialService.GetAllAsync() ?? new(); ApplyFilters(); isLoading = false; }

    private void ApplyFilters() { filteredProducts = products; if (!string.IsNullOrWhiteSpace(searchTerm)) filteredProducts = filteredProducts.Where(p => p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList(); if (filterCategoryId > 0) filteredProducts = filteredProducts.Where(p => p.CategoryId == filterCategoryId).ToList(); if (filterSupplierId > 0) filteredProducts = filteredProducts.Where(p => p.SupplierId == filterSupplierId).ToList(); }

    private string GetSupplierName(int id) => suppliers.FirstOrDefault(s => s.Id == id)?.SupplierName ?? "";
    private void OnSupplierChanged() { filteredMaterials = materials.Where(m => m.SupplierId == editSupplierId).ToList(); editMaterialId = 0; }

    private void ViewProduct(ProductDto p) { selectedProduct = p; showViewModal = true; }
    private void OpenAddModal() { isEditMode = false; editingId = 0; ResetForm(); showModal = true; }
    private void OpenEditModal(ProductDto p) { isEditMode = true; editingId = p.Id; editName = p.Name; editDescription = p.Description; editPrice = p.Price; editCategoryId = p.CategoryId; editSupplierId = p.SupplierId; OnSupplierChanged(); showModal = true; }
    private void CloseModal() { showModal = false; ResetForm(); }
    private void ResetForm() { editName = ""; editDescription = ""; editPrice = 0; editCategoryId = 0; editSupplierId = 0; editMaterialId = 0; filteredMaterials = new(); }

    private async Task SaveProduct()
    {
        if (string.IsNullOrWhiteSpace(editName) || editCategoryId == 0 || editSupplierId == 0) { ShowToast("Uyarı", "Zorunlu alanları doldurun", ToastNotification.ToastType.Warning); return; }
        isSaving = true; StateHasChanged();
        bool success;
        if (isEditMode) { var dto = new UpdateProductDto { Name = editName, Description = editDescription, Price = editPrice }; success = await ProductService.UpdateAsync(editingId, dto); }
        else { var dto = new CreateProductDto { Name = editName, Description = editDescription, Price = editPrice, CategoryId = editCategoryId, SupplierId = editSupplierId, SupplierMaterialId = editMaterialId }; success = await ProductService.CreateAsync(dto); }
        if (success) { CloseModal(); await LoadData(); ShowToast("Başarılı", isEditMode ? "Güncellendi" : "Eklendi", ToastNotification.ToastType.Success); }
        else ShowToast("Hata", "İşlem başarısız", ToastNotification.ToastType.Error);
        isSaving = false;
    }

    private void OpenDeleteDialog(ProductDto p) { deleteItemId = p.Id; deleteItemName = p.Name; showDeleteDialog = true; }
    private async Task ConfirmDelete() { isDeleting = true; StateHasChanged(); if (await ProductService.DeleteAsync(deleteItemId)) { showDeleteDialog = false; await LoadData(); ShowToast("Başarılı", "Silindi", ToastNotification.ToastType.Success); } isDeleting = false; }
    private async void ShowToast(string title, string msg, ToastNotification.ToastType type) { toastTitle = title; toastMessage = msg; toastType = type; showToast = true; StateHasChanged(); await Task.Delay(3000); showToast = false; StateHasChanged(); }
}