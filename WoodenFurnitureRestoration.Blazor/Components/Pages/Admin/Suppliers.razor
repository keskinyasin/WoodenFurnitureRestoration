@page "/admin/suppliers"
@rendermode InteractiveServer
@attribute [StreamRendering(false)]
@attribute [AuthorizeAdmin]
@layout AdminLayout
@using WoodenFurnitureRestoration.Blazor.Services
@using WoodenFurnitureRestoration.Blazor.Components.Shared
@using WoodenFurnitureRestoration.Shared.DTOs.Supplier
@inject AuthService AuthService
@inject SupplierService SupplierService
@inject NavigationManager Navigation
@inject ILogger<Suppliers> Logger

@if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;"><div class="spinner-border text-primary" role="status"></div></div>
}
else
{
    <ToastNotification IsVisible="@showToast" Title="@toastTitle" Message="@toastMessage" Type="@toastType" OnClose="() => showToast = false" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">🏭 Tedarikçiler Yönetimi</h2>
            <p class="text-muted mb-0">Toplam @suppliers.Count tedarikçi</p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="OpenAddModal"><i class="bi bi-plus-circle me-2"></i> Yeni Tedarikçi</button>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" placeholder="🔍 Tedarikçi veya mağaza ara..." @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters"><i class="bi bi-x-circle me-1"></i> Temizle</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else if (filteredSuppliers?.Count == 0)
            {
                <div class="text-center py-5"><i class="bi bi-building text-muted" style="font-size: 4rem;"></i><p class="mt-3 text-muted fs-5">Tedarikçi bulunamadı</p></div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Tedarikçi</th>
                                <th>Mağaza</th>
                                <th>E-posta</th>
                                <th>Telefon</th>
                                <th class="text-center">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var supplier in filteredSuppliers)
                            {
                                <tr>
                                    <td><span class="badge bg-secondary">@supplier.Id</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                                <i class="bi bi-building"></i>
                                            </div>
                                            <strong>@supplier.SupplierName</strong>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-primary">@supplier.ShopName</span></td>
                                    <td><i class="bi bi-envelope me-1"></i>@supplier.SupplierEmail</td>
                                    <td><i class="bi bi-telephone me-1"></i>@supplier.SupplierPhone</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-info" @onclick="@(() => ViewSupplier(supplier))"><i class="bi bi-eye"></i></button>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenEditModal(supplier))"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => OpenDeleteDialog(supplier))"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- View Modal -->
    <AdminModal IsVisible="@showViewModal" Title="🏭 Tedarikçi Detayı" OnClose="@(() => showViewModal = false)" ShowFooter="false" ModalSize="modal-lg">
        @if (selectedSupplier != null)
        {
            <div class="text-center mb-4">
                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;"><i class="bi bi-building fs-1"></i></div>
                <h3 class="mt-3">@selectedSupplier.SupplierName</h3>
                <span class="badge bg-primary fs-6">@selectedSupplier.ShopName</span>
            </div>
            <div class="row">
                <div class="col-md-6"><p><i class="bi bi-envelope me-2"></i><strong>E-posta:</strong> @selectedSupplier.SupplierEmail</p></div>
                <div class="col-md-6"><p><i class="bi bi-telephone me-2"></i><strong>Telefon:</strong> @selectedSupplier.SupplierPhone</p></div>
                <div class="col-md-12"><p><i class="bi bi-geo-alt me-2"></i><strong>Adres:</strong> @selectedSupplier.SupplierAddress</p></div>
            </div>
        }
    </AdminModal>

    <!-- Add/Edit Modal -->
    <AdminModal IsVisible="@showModal" Title="@(isEditMode ? "✏️ Tedarikçi Düzenle" : "➕ Yeni Tedarikçi")" OnClose="CloseModal" OnSave="SaveSupplier" IsSaving="@isSaving" ModalSize="modal-lg">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Tedarikçi Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control @(errors.ContainsKey("Name") ? "is-invalid" : "")" @bind="editName" maxlength="50" placeholder="En az 3, en fazla 50 karakter" />
                @if (errors.ContainsKey("Name"))
                {
                    <div class="invalid-feedback">@errors["Name"]</div>
                }
                <small class="text-muted">@editName.Length / 50</small>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Mağaza Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control @(errors.ContainsKey("ShopName") ? "is-invalid" : "")" @bind="editShopName" maxlength="50" placeholder="En az 2, en fazla 50 karakter" />
                @if (errors.ContainsKey("ShopName"))
                {
                    <div class="invalid-feedback">@errors["ShopName"]</div>
                }
                <small class="text-muted">@editShopName.Length / 50</small>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">E-posta</label>
                <input type="email" class="form-control @(errors.ContainsKey("Email") ? "is-invalid" : "")" @bind="editEmail" placeholder="ornek@mail.com" />
                @if (errors.ContainsKey("Email"))
                {
                    <div class="invalid-feedback">@errors["Email"]</div>
                }
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Telefon <span class="text-danger">*</span></label>
                <input type="tel" class="form-control @(errors.ContainsKey("Phone") ? "is-invalid" : "")" @bind="editPhone" maxlength="20" placeholder="05XX XXX XX XX" />
                @if (errors.ContainsKey("Phone"))
                {
                    <div class="invalid-feedback">@errors["Phone"]</div>
                }
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label fw-bold">Adres <span class="text-danger">*</span></label>
                <textarea class="form-control @(errors.ContainsKey("Address") ? "is-invalid" : "")" rows="3" @bind="editAddress" maxlength="500" placeholder="En az 10, en fazla 500 karakter"></textarea>
                @if (errors.ContainsKey("Address"))
                {
                    <div class="invalid-feedback">@errors["Address"]</div>
                }
                <small class="text-muted">@editAddress.Length / 500</small>
            </div>
        </div>
    </AdminModal>

    <ConfirmDialog IsVisible="@showDeleteDialog" Title="Tedarikçi Sil" Message="Bu tedarikçiyi silmek istediğinizden emin misiniz?" ItemName="@deleteItemName" IsProcessing="@isDeleting" OnConfirm="ConfirmDelete" OnCancel="@(() => showDeleteDialog = false)" />
}

@code {
    private bool isAuthenticated, isLoading, isChecked, showViewModal, showModal, isEditMode, isSaving, showDeleteDialog, isDeleting, showToast;
    private List<SupplierDto> suppliers = new();
    private List<SupplierDto> filteredSuppliers = new();
    private SupplierDto? selectedSupplier;
    private int editingId, deleteItemId;
    private string deleteItemName = "", toastTitle = "", toastMessage = "";
    private ToastNotification.ToastType toastType;

    private string searchTerm = "";
    private string editName = "", editShopName = "", editEmail = "", editPhone = "", editAddress = "";
    private Dictionary<string, string> errors = new();

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender && !isChecked) { isChecked = true; isAuthenticated = await AuthService.IsAdminLoggedInAsync(); if (!isAuthenticated) { Navigation.NavigateTo("/admin", replace: true); return; } await LoadData(); StateHasChanged(); } }

    private async Task LoadData() { isLoading = true; StateHasChanged(); suppliers = await SupplierService.GetAllAsync() ?? new(); ApplyFilters(); isLoading = false; }

    private void ApplyFilters()
    {
        filteredSuppliers = suppliers;
        if (!string.IsNullOrWhiteSpace(searchTerm)) filteredSuppliers = filteredSuppliers.Where(s => s.SupplierName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || s.ShopName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private void ClearFilters() { searchTerm = ""; ApplyFilters(); }
    private void ViewSupplier(SupplierDto s) { selectedSupplier = s; showViewModal = true; }
    private void OpenAddModal() { isEditMode = false; editingId = 0; ResetForm(); showModal = true; }
    private void OpenEditModal(SupplierDto s) { isEditMode = true; editingId = s.Id; editName = s.SupplierName; editShopName = s.ShopName; editEmail = s.SupplierEmail ?? ""; editPhone = s.SupplierPhone; editAddress = s.SupplierAddress; showModal = true; }
    private void CloseModal() { showModal = false; ResetForm(); }
    private void ResetForm() { editName = ""; editShopName = ""; editEmail = ""; editPhone = ""; editAddress = ""; errors.Clear(); }

    private bool ValidateForm()
    {
        errors.Clear();

        // Tedarikçi Adı
        if (string.IsNullOrWhiteSpace(editName))
            errors["Name"] = "Tedarikçi adı zorunludur.";
        else if (editName.Trim().Length < 3)
            errors["Name"] = "Tedarikçi adı en az 3 karakter olmalıdır.";
        else if (editName.Trim().Length > 50)
            errors["Name"] = "Tedarikçi adı en fazla 50 karakter olabilir.";

        // Mağaza Adı
        if (string.IsNullOrWhiteSpace(editShopName))
            errors["ShopName"] = "Mağaza adı zorunludur.";
        else if (editShopName.Trim().Length < 2)
            errors["ShopName"] = "Mağaza adı en az 2 karakter olmalıdır.";
        else if (editShopName.Trim().Length > 50)
            errors["ShopName"] = "Mağaza adı en fazla 50 karakter olabilir.";

        // E-posta (opsiyonel ama format kontrolü)
        if (!string.IsNullOrWhiteSpace(editEmail) && !IsValidEmail(editEmail))
            errors["Email"] = "Geçerli bir e-posta adresi giriniz. (örn: ornek@mail.com)";

        // Telefon
        if (string.IsNullOrWhiteSpace(editPhone))
            errors["Phone"] = "Telefon numarası zorunludur.";
        else if (editPhone.Trim().Length < 10)
            errors["Phone"] = "Telefon numarası en az 10 karakter olmalıdır.";
        else if (editPhone.Trim().Length > 20)
            errors["Phone"] = "Telefon numarası en fazla 20 karakter olabilir.";

        // Adres
        if (string.IsNullOrWhiteSpace(editAddress))
            errors["Address"] = "Adres zorunludur.";
        else if (editAddress.Trim().Length < 10)
            errors["Address"] = "Adres en az 10 karakter olmalıdır.";
        else if (editAddress.Trim().Length > 500)
            errors["Address"] = "Adres en fazla 500 karakter olabilir.";

        return errors.Count == 0;
    }

    private static bool IsValidEmail(string email)
    {
        try { var addr = new System.Net.Mail.MailAddress(email); return addr.Address == email; }
        catch { return false; }
    }

    private async Task SaveSupplier()
    {
        if (!ValidateForm())
        {
            ShowToast("Uyarı", "Lütfen formdaki hataları düzeltin.", ToastNotification.ToastType.Warning);
            return;
        }

        isSaving = true; StateHasChanged();

        bool success;
        if (isEditMode)
        {
            success = await SupplierService.UpdateAsync(editingId, new UpdateSupplierDto
            {
                SupplierName = editName.Trim(),
                ShopName = editShopName.Trim(),
                SupplierEmail = string.IsNullOrWhiteSpace(editEmail) ? null : editEmail.Trim(),
                SupplierPhone = editPhone.Trim(),
                SupplierAddress = editAddress.Trim()
            });
        }
        else
        {
            success = await SupplierService.CreateAsync(new CreateSupplierDto
            {
                SupplierName = editName.Trim(),
                ShopName = editShopName.Trim(),
                SupplierEmail = string.IsNullOrWhiteSpace(editEmail) ? null : editEmail.Trim(),
                SupplierPhone = editPhone.Trim(),
                SupplierAddress = editAddress.Trim()
            });
        }

        if (success) { CloseModal(); await LoadData(); ShowToast("Başarılı", isEditMode ? "Tedarikçi güncellendi" : "Tedarikçi eklendi", ToastNotification.ToastType.Success); }
        else ShowToast("Hata", "İşlem başarısız. Lütfen tekrar deneyin.", ToastNotification.ToastType.Error);
        isSaving = false;
    }

    private void OpenDeleteDialog(SupplierDto s) { deleteItemId = s.Id; deleteItemName = s.SupplierName; showDeleteDialog = true; }
    private async Task ConfirmDelete() { isDeleting = true; StateHasChanged(); if (await SupplierService.DeleteAsync(deleteItemId)) { showDeleteDialog = false; await LoadData(); ShowToast("Başarılı", "Tedarikçi silindi", ToastNotification.ToastType.Success); } isDeleting = false; }
    private async void ShowToast(string title, string msg, ToastNotification.ToastType type) { toastTitle = title; toastMessage = msg; toastType = type; showToast = true; StateHasChanged(); await Task.Delay(3000); showToast = false; StateHasChanged(); }
}