@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [StreamRendering(false)]
@layout AdminLayout
@using WoodenFurnitureRestoration.Blazor.Services
@using WoodenFurnitureRestoration.Blazor.Components
@attribute [AuthorizeAdmin]
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<Dashboard> Logger

@if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
    </div>
}
else
{
    <div class="dashboard-container">
        <div class="dashboard-header mb-4">
            <h1>👋 Admin Panele Hoşgeldiniz</h1>
            <p class="text-muted">Wooden Furniture Restoration - Yönetim Paneli</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon bg-primary">
                        <i class="bi bi-list"></i>
                    </div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Kategoriler</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon bg-success">
                        <i class="bi bi-box"></i>
                    </div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Ürünler</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon bg-warning">
                        <i class="bi bi-cart"></i>
                    </div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Siparişler</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="stat-icon bg-info">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-content">
                        <h3>0</h3>
                        <p>Müşteriler</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card welcome-card">
                    <div class="card-body">
                        <h5>👋 Hoşgeldiniz!</h5>
                        <p>Wooden Furniture Restoration yönetim paneline hoş geldiniz.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isChecked = false;

    // ✅ OnAfterRenderAsync kullan (JS burada çalışır!)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isChecked)
        {
            isChecked = true;
            Logger.LogInformation("🔐 [Dashboard] Auth check (OnAfterRenderAsync)...");

            isAuthenticated = await AuthService.IsAdminLoggedInAsync();

            if (!isAuthenticated)
            {
                Logger.LogWarning("❌ [Dashboard] Unauthorized - redirect!");
                Navigation.NavigateTo("/admin", replace: true);
            }
            else
            {
                Logger.LogInformation("✅ [Dashboard] Authorized");
                StateHasChanged(); // UI'ı güncelle
            }
        }
    }
}