@page "/admin/categories"
@rendermode InteractiveServer
@attribute [StreamRendering(false)]
@attribute [AuthorizeAdmin]
@layout AdminLayout
@using WoodenFurnitureRestoration.Blazor.Services
@using WoodenFurnitureRestoration.Blazor.Components.Shared
@using WoodenFurnitureRestoration.Shared.DTOs.Category
@using WoodenFurnitureRestoration.Shared.DTOs.Supplier
@inject AuthService AuthService
@inject CategoryService CategoryService
@inject SupplierService SupplierService
@inject NavigationManager Navigation
@inject ILogger<Categories> Logger

@if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <ToastNotification IsVisible="@showToast" Title="@toastTitle" Message="@toastMessage" Type="@toastType" OnClose="() => showToast = false" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">📂 Kategoriler</h2>
            <p class="text-muted mb-0">Toplam @categories.Count kategori</p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="OpenAddModal">
            <i class="bi bi-plus-circle me-2"></i> Yeni Kategori
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Kategori ara..." @bind="searchTerm" @bind:event="oninput" @onkeyup="FilterCategories" />
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" @onclick="RefreshData">
                        <i class="bi bi-arrow-clockwise me-1"></i> Yenile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else if (filteredCategories?.Count == 0)
            {
                <div class="text-center py-5">
                    <i class="bi bi-folder text-muted" style="font-size: 4rem;"></i>
                    <p class="mt-3 text-muted fs-5">Kategori bulunamadı</p>
                    <button class="btn btn-primary" @onclick="OpenAddModal">
                        <i class="bi bi-plus-circle me-2"></i> İlk Kategoriyi Ekle
                    </button>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Kategori Adı</th>
                                <th>Açıklama</th>
                                <th>Tedarikçi</th>
                                <th>Oluşturulma</th>
                                <th class="text-center">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var category in filteredCategories)
                            {
                                <tr>
                                    <td><span class="badge bg-secondary">@category.Id</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                                <i class="bi bi-folder"></i>
                                            </div>
                                            <strong>@category.Name</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            @(string.IsNullOrEmpty(category.Description) ? "-" :
                                                                            category.Description.Length > 50 ? category.Description.Substring(0, 50) + "..." : category.Description)
                                        </small>
                                    </td>
                                    <td><span class="badge bg-info">@category.SupplierName</span></td>
                                    <td><small>@category.CreatedAt.ToString("dd MMM yyyy")</small></td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-info" @onclick="@(() => ViewCategory(category))" title="Detay">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenEditModal(category))" title="Düzenle">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => OpenDeleteDialog(category))" title="Sil">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- View Modal -->
    <AdminModal IsVisible="@showViewModal" Title="📂 Kategori Detayı" OnClose="@(() => showViewModal = false)" ShowFooter="false">
        @if (selectedCategory != null)
        {
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                    <i class="bi bi-folder fs-1"></i>
                </div>
                <h4 class="mt-3">@selectedCategory.Name</h4>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ID:</strong> @selectedCategory.Id</p>
                    <p><strong>Tedarikçi:</strong> <span class="badge bg-info">@selectedCategory.SupplierName</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Oluşturulma:</strong> @selectedCategory.CreatedAt.ToString("dd MMMM yyyy HH:mm")</p>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(selectedCategory.Description))
            {
                <hr />
                <p><strong>Açıklama:</strong></p>
                <p class="text-muted">@selectedCategory.Description</p>
            }
        }
    </AdminModal>

    <!-- Add/Edit Modal -->
    <AdminModal IsVisible="@showModal"
                Title="@(isEditMode ? "✏️ Kategori Düzenle" : "➕ Yeni Kategori")"
                OnClose="CloseModal"
                OnSave="SaveCategory"
                IsSaving="@isSaving"
                SaveButtonText="@(isEditMode ? "💾 Güncelle" : "➕ Ekle")"
                HeaderClass="@(isEditMode ? "bg-warning text-dark" : "bg-primary text-white")">

        <div class="mb-3">
            <label class="form-label fw-bold">Kategori Adı <span class="text-danger">*</span></label>
            <input type="text" class="form-control" @bind="editName" placeholder="Kategori adı..." />
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Tedarikçi <span class="text-danger">*</span></label>
            <select class="form-select" @bind="editSupplierId">
                <option value="0">-- Tedarikçi Seçin --</option>
                @foreach (var s in suppliers)
                {
                    <option value="@s.Id">@s.SupplierName</option>
                }
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Açıklama</label>
            <textarea class="form-control" rows="4" @bind="editDescription" placeholder="Kategori açıklaması (opsiyonel)..."></textarea>
        </div>
    </AdminModal>

    <ConfirmDialog IsVisible="@showDeleteDialog"
                   Title="Kategori Sil"
                   Message="Bu kategoriyi silmek istediğinizden emin misiniz? Bu kategoriye ait ürünler etkilenebilir."
                   ItemName="@deleteItemName"
                   IsProcessing="@isDeleting"
                   OnConfirm="ConfirmDelete"
                   OnCancel="@(() => showDeleteDialog = false)" />
}

@code {
    private bool isAuthenticated, isLoading, isChecked, showViewModal, showModal, isEditMode, isSaving, showDeleteDialog, isDeleting, showToast;
    private List<CategoryDto> categories = new();
    private List<CategoryDto> filteredCategories = new();
    private List<SupplierDto> suppliers = new();
    private CategoryDto? selectedCategory;
    private string searchTerm = "";
    private int editingId, deleteItemId;
    private string deleteItemName = "", toastTitle = "", toastMessage = "";
    private ToastNotification.ToastType toastType;

    // Form fields
    private string editName = "";
    private string editDescription = "";
    private int editSupplierId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isChecked)
        {
            isChecked = true;
            isAuthenticated = await AuthService.IsAdminLoggedInAsync();
            if (!isAuthenticated) { Navigation.NavigateTo("/admin", replace: true); return; }
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        categories = await CategoryService.GetAllAsync() ?? new();
        suppliers = await SupplierService.GetAllAsync() ?? new();
        filteredCategories = categories.ToList();
        isLoading = false;
    }

    private void FilterCategories()
    {
        filteredCategories = string.IsNullOrWhiteSpace(searchTerm)
            ? categories.ToList()
            : categories.Where(c =>
                c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (c.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            ).ToList();
    }

    private async Task RefreshData()
    {
        searchTerm = "";
        await LoadData();
        ShowToast("Başarılı", "Veriler yenilendi", ToastNotification.ToastType.Success);
    }

    private void ViewCategory(CategoryDto category)
    {
        selectedCategory = category;
        showViewModal = true;
    }

    private void OpenAddModal()
    {
        isEditMode = false;
        editingId = 0;
        editName = "";
        editDescription = "";
        editSupplierId = 0;
        showModal = true;
    }

    private void OpenEditModal(CategoryDto category)
    {
        isEditMode = true;
        editingId = category.Id;
        editName = category.Name;
        editDescription = category.Description ?? "";
        editSupplierId = category.SupplierId;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editName = "";
        editDescription = "";
        editSupplierId = 0;
    }

    private async Task SaveCategory()
    {
        if (string.IsNullOrWhiteSpace(editName) || editSupplierId == 0)
        {
            ShowToast("Uyarı", "Lütfen zorunlu alanları doldurun", ToastNotification.ToastType.Warning);
            return;
        }

        isSaving = true;
        StateHasChanged();

        try
        {
            bool success;
            if (isEditMode)
            {
                var dto = new UpdateCategoryDto
                {
                    Name = editName,
                    Description = editDescription
                };
                success = await CategoryService.UpdateAsync(editingId, dto);
            }
            else
            {
                var dto = new CreateCategoryDto
                {
                    Name = editName,
                    Description = editDescription,
                    SupplierId = editSupplierId
                };
                success = await CategoryService.CreateAsync(dto);
            }

            if (success)
            {
                CloseModal();
                await LoadData();
                ShowToast("Başarılı", isEditMode ? "Kategori güncellendi" : "Kategori eklendi", ToastNotification.ToastType.Success);
            }
            else
            {
                ShowToast("Hata", "İşlem başarısız", ToastNotification.ToastType.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Kategori kaydetme hatası");
            ShowToast("Hata", "Bir hata oluştu", ToastNotification.ToastType.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void OpenDeleteDialog(CategoryDto category)
    {
        deleteItemId = category.Id;
        deleteItemName = category.Name;
        showDeleteDialog = true;
    }

    private async Task ConfirmDelete()
    {
        isDeleting = true;
        StateHasChanged();

        if (await CategoryService.DeleteAsync(deleteItemId))
        {
            showDeleteDialog = false;
            await LoadData();
            ShowToast("Başarılı", "Kategori silindi", ToastNotification.ToastType.Success);
        }
        else
        {
            ShowToast("Hata", "Silme başarısız. Bu kategoriye ait ürünler olabilir.", ToastNotification.ToastType.Error);
        }

        isDeleting = false;
    }

    private async void ShowToast(string title, string msg, ToastNotification.ToastType type)
    {
        toastTitle = title;
        toastMessage = msg;
        toastType = type;
        showToast = true;
        StateHasChanged();
        await Task.Delay(3000);
        showToast = false;
        StateHasChanged();
    }
}