@page "/admin/supplier-materials"
@page "/admin/suppliermaterials"
@rendermode InteractiveServer
@attribute [StreamRendering(false)]
@attribute [AuthorizeAdmin]
@layout AdminLayout
@using WoodenFurnitureRestoration.Blazor.Services
@using WoodenFurnitureRestoration.Blazor.Components.Shared
@using WoodenFurnitureRestoration.Shared.DTOs.SupplierMaterial
@using WoodenFurnitureRestoration.Shared.DTOs.Supplier
@using WoodenFurnitureRestoration.Shared.DTOs.Category
@inject AuthService AuthService
@inject SupplierMaterialService SupplierMaterialService
@inject SupplierService SupplierService
@inject CategoryService CategoryService
@inject NavigationManager Navigation
@inject ILogger<SupplierMaterials> Logger

@if (!isAuthenticated)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;"><div class="spinner-border text-primary" role="status"></div></div>
}
else
{
    <ToastNotification IsVisible="@showToast" Title="@toastTitle" Message="@toastMessage" Type="@toastType" OnClose="() => showToast = false" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">🧱 Tedarikçi Malzemeleri</h2>
            <p class="text-muted mb-0">Toplam @materials.Count malzeme | <strong class="text-success">₺@materials.Sum(m => m.MaterialPrice * m.MaterialQuantity).ToString("N2")</strong></p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="OpenAddModal"><i class="bi bi-plus-circle me-2"></i> Yeni Malzeme</button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select" @bind="filterSupplierId" @bind:after="ApplyFilters">
                        <option value="0">Tüm Tedarikçiler</option>
                        @foreach (var s in suppliers)
                        {
                            <option value="@s.Id">@s.SupplierName</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="filterCategoryId" @bind:after="ApplyFilters">
                        <option value="0">Tüm Kategoriler</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters"><i class="bi bi-x-circle me-1"></i> Temizle</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }
            else if (filteredMaterials?.Count == 0)
            {
                <div class="text-center py-5"><i class="bi bi-box-seam text-muted" style="font-size: 4rem;"></i><p class="mt-3 text-muted fs-5">Malzeme bulunamadı</p></div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Malzeme</th>
                                <th>Tedarikçi</th>
                                <th>Kategori</th>
                                <th>Miktar</th>
                                <th>Fiyat</th>
                                <th>Durum</th>
                                <th class="text-center">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var m in filteredMaterials)
                            {
                                <tr>
                                    <td><span class="badge bg-secondary">@m.Id</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-warning text-dark rounded d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;"><i class="bi bi-box-seam"></i></div>
                                            <div>
                                                <strong>@m.MaterialName</strong>
                                                <br /><small class="text-muted">@m.MaterialType</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-success"><i class="bi bi-building me-1"></i>@m.SupplierName</span></td>
                                    <td><span class="badge bg-info"><i class="bi bi-folder me-1"></i>@m.CategoryName</span></td>
                                    <td><span class="badge bg-dark">@m.MaterialQuantity adet</span></td>
                                    <td><strong class="text-success">₺@m.MaterialPrice.ToString("N2")</strong></td>
                                    <td><span class="badge @(m.MaterialStatus == "Active" ? "bg-success" : "bg-secondary")">@m.MaterialStatus</span></td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-info" @onclick="@(() => ViewMaterial(m))"><i class="bi bi-eye"></i></button>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => OpenEditModal(m))"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => OpenDeleteDialog(m))"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <AdminModal IsVisible="@showViewModal" Title="🧱 Malzeme Detayı" OnClose="@(() => showViewModal = false)" ShowFooter="false" ModalSize="modal-lg">
        @if (selectedMaterial != null)
        {
            <div class="row mb-4">
                <div class="col-md-6"><div class="card border-success"><div class="card-header bg-success text-white"><i class="bi bi-building me-1"></i> Tedarikçi</div><div class="card-body"><h5>@selectedMaterial.SupplierName</h5></div></div></div>
                <div class="col-md-6"><div class="card border-info"><div class="card-header bg-info text-white"><i class="bi bi-folder me-1"></i> Kategori</div><div class="card-body"><h5>@selectedMaterial.CategoryName</h5></div></div></div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h4>@selectedMaterial.MaterialName</h4>
                    <p class="text-muted">@selectedMaterial.MaterialDescription</p>
                    <div class="row mt-3">
                        <div class="col-md-3 text-center"><h6 class="text-muted">Miktar</h6><h4>@selectedMaterial.MaterialQuantity</h4></div>
                        <div class="col-md-3 text-center"><h6 class="text-muted">Birim Fiyat</h6><h4>₺@selectedMaterial.MaterialPrice.ToString("N2")</h4></div>
                        <div class="col-md-3 text-center"><h6 class="text-muted">Toplam</h6><h4 class="text-success">₺@((selectedMaterial.MaterialPrice * selectedMaterial.MaterialQuantity).ToString("N2"))</h4></div>
                        <div class="col-md-3 text-center"><h6 class="text-muted">Durum</h6><span class="badge @(selectedMaterial.MaterialStatus == "Active" ? "bg-success" : "bg-secondary") fs-6">@selectedMaterial.MaterialStatus</span></div>
                    </div>
                </div>
            </div>
        }
    </AdminModal>

    <AdminModal IsVisible="@showModal" Title="@(isEditMode ? "✏️ Malzeme Düzenle" : "➕ Yeni Malzeme")" OnClose="CloseModal" OnSave="SaveMaterial" IsSaving="@isSaving" ModalSize="modal-lg">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold"><i class="bi bi-building me-1"></i> Tedarikçi <span class="text-danger">*</span></label>
                <select class="form-select @(errors.ContainsKey("Supplier") ? "is-invalid" : "")" @bind="editSupplierId">
                    <option value="0">-- Tedarikçi Seçin --</option>
                    @foreach (var s in suppliers)
                    {
                        <option value="@s.Id">@s.SupplierName</option>
                    }
                </select>
                @if (errors.ContainsKey("Supplier"))
                {
                    <div class="invalid-feedback">@errors["Supplier"]</div>
                }
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold"><i class="bi bi-folder me-1"></i> Kategori <span class="text-danger">*</span></label>
                <select class="form-select @(errors.ContainsKey("Category") ? "is-invalid" : "")" @bind="editCategoryId">
                    <option value="0">-- Kategori Seçin --</option>
                    @foreach (var c in categories)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </select>
                @if (errors.ContainsKey("Category"))
                {
                    <div class="invalid-feedback">@errors["Category"]</div>
                }
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Malzeme Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control @(errors.ContainsKey("Name") ? "is-invalid" : "")" @bind="editName" maxlength="150" placeholder="En az 3 karakter" />
                @if (errors.ContainsKey("Name"))
                {
                    <div class="invalid-feedback">@errors["Name"]</div>
                }
                <small class="text-muted">@editName.Length / 150</small>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Malzeme Türü <span class="text-danger">*</span></label>
                <input type="text" class="form-control @(errors.ContainsKey("Type") ? "is-invalid" : "")" @bind="editType" maxlength="50" placeholder="Ahşap, Metal, vb." />
                @if (errors.ContainsKey("Type"))
                {
                    <div class="invalid-feedback">@errors["Type"]</div>
                }
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Açıklama <span class="text-danger">*</span></label>
            <textarea class="form-control @(errors.ContainsKey("Description") ? "is-invalid" : "")" rows="2" @bind="editDescription" maxlength="500" placeholder="Malzeme hakkında kısa açıklama"></textarea>
            @if (errors.ContainsKey("Description"))
            {
                <div class="invalid-feedback">@errors["Description"]</div>
            }
            <small class="text-muted">@editDescription.Length / 500</small>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Miktar <span class="text-danger">*</span></label>
                <input type="number" class="form-control @(errors.ContainsKey("Quantity") ? "is-invalid" : "")" @bind="editQuantity" min="0" />
                @if (errors.ContainsKey("Quantity"))
                {
                    <div class="invalid-feedback">@errors["Quantity"]</div>
                }
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Birim Fiyat <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text">₺</span>
                    <input type="number" step="0.01" class="form-control @(errors.ContainsKey("Price") ? "is-invalid" : "")" @bind="editPrice" />
                </div>
                @if (errors.ContainsKey("Price"))
                {
                    <div class="text-danger small">@errors["Price"]</div>
                }
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Durum</label>
                <select class="form-select" @bind="editStatus">
                    <option value="Active">Aktif</option>
                    <option value="Inactive">Pasif</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Kategori Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control @(errors.ContainsKey("MaterialCategory") ? "is-invalid" : "")" @bind="editMaterialCategory" maxlength="50" placeholder="Hammadde, Yardımcı Malzeme..." />
                @if (errors.ContainsKey("MaterialCategory"))
                {
                    <div class="invalid-feedback">@errors["MaterialCategory"]</div>
                }
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Toplam Tutar</label>
                <div class="input-group">
                    <span class="input-group-text">₺</span>
                    <input type="text" class="form-control bg-light" value="@((editQuantity * editPrice).ToString("N2"))" readonly />
                </div>
            </div>
        </div>
    </AdminModal>

    <ConfirmDialog IsVisible="@showDeleteDialog" Title="Malzeme Sil" Message="Bu malzemeyi silmek istediğinizden emin misiniz?" ItemName="@deleteItemName" IsProcessing="@isDeleting" OnConfirm="ConfirmDelete" OnCancel="@(() => showDeleteDialog = false)" />
}

@code {
    private bool isAuthenticated, isLoading, isChecked, showViewModal, showModal, isEditMode, isSaving, showDeleteDialog, isDeleting, showToast;
    private List<SupplierMaterialDto> materials = new();
    private List<SupplierMaterialDto> filteredMaterials = new();
    private List<SupplierDto> suppliers = new();
    private List<CategoryDto> categories = new();
    private SupplierMaterialDto? selectedMaterial;
    private int editingId, deleteItemId;
    private string deleteItemName = "", toastTitle = "", toastMessage = "";
    private ToastNotification.ToastType toastType;

    private int filterSupplierId, filterCategoryId;
    private string editName = "", editDescription = "", editType = "", editStatus = "Active", editMaterialCategory = "";
    private int editSupplierId, editCategoryId, editQuantity;
    private decimal editPrice;
    private Dictionary<string, string> errors = new();

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender && !isChecked) { isChecked = true; isAuthenticated = await AuthService.IsAdminLoggedInAsync(); if (!isAuthenticated) { Navigation.NavigateTo("/admin", replace: true); return; } await LoadData(); StateHasChanged(); } }

    private async Task LoadData() { isLoading = true; StateHasChanged(); materials = await SupplierMaterialService.GetAllAsync() ?? new(); suppliers = await SupplierService.GetAllAsync() ?? new(); categories = await CategoryService.GetAllAsync() ?? new(); ApplyFilters(); isLoading = false; }

    private void ApplyFilters() { filteredMaterials = materials; if (filterSupplierId > 0) filteredMaterials = filteredMaterials.Where(m => m.SupplierId == filterSupplierId).ToList(); if (filterCategoryId > 0) filteredMaterials = filteredMaterials.Where(m => m.CategoryId == filterCategoryId).ToList(); }
    private void ClearFilters() { filterSupplierId = 0; filterCategoryId = 0; ApplyFilters(); }

    private void ViewMaterial(SupplierMaterialDto m) { selectedMaterial = m; showViewModal = true; }
    private void OpenAddModal() { isEditMode = false; editingId = 0; ResetForm(); showModal = true; }
    private void OpenEditModal(SupplierMaterialDto m)
    {
        isEditMode = true; editingId = m.Id;
        editSupplierId = m.SupplierId; editCategoryId = m.CategoryId;
        editName = m.MaterialName; editDescription = m.MaterialDescription;
        editType = m.MaterialType; editQuantity = m.MaterialQuantity;
        editPrice = m.MaterialPrice; editStatus = m.MaterialStatus;
        editMaterialCategory = m.MaterialCategory;
        errors.Clear(); showModal = true;
    }
    private void CloseModal() { showModal = false; ResetForm(); }
    private void ResetForm()
    {
        editSupplierId = 0; editCategoryId = 0; editName = ""; editDescription = "";
        editType = ""; editQuantity = 0; editPrice = 0; editStatus = "Active";
        editMaterialCategory = ""; errors.Clear();
    }

    private bool ValidateForm()
    {
        errors.Clear();

        if (editSupplierId == 0)
            errors["Supplier"] = "Tedarikçi seçimi zorunludur.";

        if (editCategoryId == 0)
            errors["Category"] = "Kategori seçimi zorunludur.";

        if (string.IsNullOrWhiteSpace(editName))
            errors["Name"] = "Malzeme adı zorunludur.";
        else if (editName.Trim().Length < 3)
            errors["Name"] = "Malzeme adı en az 3 karakter olmalıdır.";

        if (string.IsNullOrWhiteSpace(editType))
            errors["Type"] = "Malzeme türü zorunludur.";

        if (string.IsNullOrWhiteSpace(editDescription))
            errors["Description"] = "Açıklama zorunludur.";
        else if (editDescription.Trim().Length < 5)
            errors["Description"] = "Açıklama en az 5 karakter olmalıdır.";

        if (string.IsNullOrWhiteSpace(editMaterialCategory))
            errors["MaterialCategory"] = "Kategori adı zorunludur.";

        if (editQuantity < 0)
            errors["Quantity"] = "Miktar 0 veya daha büyük olmalıdır.";

        if (editPrice <= 0)
            errors["Price"] = "Fiyat 0'dan büyük olmalıdır.";

        return errors.Count == 0;
    }

    private async Task SaveMaterial()
    {
        if (!ValidateForm())
        {
            ShowToast("Uyarı", "Lütfen formdaki hataları düzeltin.", ToastNotification.ToastType.Warning);
            return;
        }

        isSaving = true; StateHasChanged();

        try
        {
            bool success;
            if (isEditMode)
            {
                success = await SupplierMaterialService.UpdateAsync(editingId, new UpdateSupplierMaterialDto
                {
                    MaterialName = editName.Trim(),
                    MaterialDescription = editDescription.Trim(),
                    MaterialType = editType.Trim(),
                    MaterialCategory = editMaterialCategory.Trim(),
                    MaterialQuantity = editQuantity,
                    MaterialPrice = editPrice,
                    MaterialStatus = editStatus
                });
            }
            else
            {
                success = await SupplierMaterialService.CreateAsync(new CreateSupplierMaterialDto
                {
                    SupplierId = editSupplierId,
                    CategoryId = editCategoryId,
                    MaterialName = editName.Trim(),
                    MaterialDescription = editDescription.Trim(),
                    MaterialType = editType.Trim(),
                    MaterialCategory = editMaterialCategory.Trim(),
                    MaterialQuantity = editQuantity,
                    MaterialPrice = editPrice
                });
            }

            if (success) { CloseModal(); await LoadData(); ShowToast("Başarılı", isEditMode ? "Malzeme güncellendi" : "Malzeme eklendi", ToastNotification.ToastType.Success); }
            else ShowToast("Hata", "İşlem başarısız. Lütfen tekrar deneyin.", ToastNotification.ToastType.Error);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Malzeme kaydetme hatası");
            ShowToast("Hata", "Bir hata oluştu.", ToastNotification.ToastType.Error);
        }
        finally { isSaving = false; }
    }

    private void OpenDeleteDialog(SupplierMaterialDto m) { deleteItemId = m.Id; deleteItemName = m.MaterialName; showDeleteDialog = true; }
    private async Task ConfirmDelete()
    {
        isDeleting = true; StateHasChanged();
        if (await SupplierMaterialService.DeleteAsync(deleteItemId)) { showDeleteDialog = false; await LoadData(); ShowToast("Başarılı", "Malzeme silindi", ToastNotification.ToastType.Success); }
        else ShowToast("Hata", "Silme başarısız", ToastNotification.ToastType.Error);
        isDeleting = false;
    }
    private async void ShowToast(string title, string msg, ToastNotification.ToastType type) { toastTitle = title; toastMessage = msg; toastType = type; showToast = true; StateHasChanged(); await Task.Delay(3000); showToast = false; StateHasChanged(); }
}